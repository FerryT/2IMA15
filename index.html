<html>
<head>
	<title>Test</title>
	<script src="jquery-2.1.4.min.js"></script>
	<script src="d3.min.js" charset="utf-8"></script>
	<script src="geometry.js"></script>
	<script src="behavior.js"></script>
	<script src="game.js"></script>
	<script src="visuals.js"></script>
	<script src="sliceAlgorithms.js"></script>
	<link rel="stylesheet" type="text/css" href="interface.css">
	<link rel="stylesheet" type="text/css" href="visuals.css">
	<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
</head>
<body>
	<!-- Icons from Open Iconic: see /ICON-LICENSE -->
	<svg version="1.1" xmlns="http://www.w3.org/2000/svg" style="display:none">
		<defs>
			<symbol id="media-play" viewBox="0 0 8 8">
				<path d="M0 0v6l6-3-6-3z" transform="translate(1 1)"></path>
			</symbol>
			<symbol id="chevron-left" viewBox="0 0 8 8">
				<path d="M4 0l-4 4 4 4 1.5-1.5-2.5-2.5 2.5-2.5-1.5-1.5z" transform="translate(1)"></path>
			</symbol>
			<symbol id="media-pause" viewBox="0 0 8 8">
				<path d="M0 0v6h2v-6h-2zm4 0v6h2v-6h-2z" transform="translate(1 1)"></path>
			</symbol>
		</defs>
	</svg>

	<header id="topbar">
		<button class="icon" id="btn-back">chevron-left</button>
		<button class="icon" id="btn-pause">media-pause</button>
		<button class="icon" id="btn-resume">media-play</button>
	</header>
	<div id="game" class="page">
		<h1>Level 1</h1>
		<svg id="field"></svg>
	</div>
	<nav id="menu" class="page">
		<a id="btn-play">Play</a>
		<a id="btn-options">Options</a>
		<a id="btn-about">About</a>
		<a id="btn-exit">Exit</a>
	</nav>
	<div id="options" class="page">
		<h1>Options</h1>
	</div>
	<nav id="about" class="page">
		<a id="btn-algorithms">Algorithms</a>
		<a id="btn-duality">Duality</a>
		<a id="btn-info">Info</a>
		<a id="btn-credits">Credits</a>
	</nav>
	<div id="loader" class="page">
		<h1>Loading...</h1>
	</div>
	<script src="interface.js"></script>
	<script>
		$(function() // Debug
		{
			$('#btn-play').click();

			var game = new Game(640, 360, 1000 / 60 /* 60 fps */),
				rect = game.rect.shrink(20),
				field = new Field('field', game),
				level1 = new Level('test'),
				behavior1 = new Behavior().Pieter(10),
				behavior2 = new Behavior().Pieter(30);

			level1.add(new Entity(rect.randomPoint(), 0, behavior1));
			level1.add(new Entity(rect.randomPoint(), 1, behavior2));
			level1.add(new Goal(new Line(0, .5, 1, .5).multiply(rect), 40));
			game.addLevel(level1);

			var groupOne = level1.points(0);
			var groupTwo = level1.points(1);

			game.start(1);
			game.slice(NaiveAlgorithm(groupOne, groupTwo))
			field.updatePoints();
			field.updateLines();

			window.game = game;
			window.field = field;

			function update()
			{
				var level = game.level,
					line = NaiveAlgorithm(level.points(0), level.points(1));
				game.slices = [];
				if (line)
					game.slice(line);
				field.updateLines();
				field.updatePoints();
				field.updateGoals();
			}

			setInterval(function(){ update(); }, game.rate); // XXX: add field update event to game update
		});
	</script>
	<script>
		//Temporary point manipulation -- removed in final version
		$(function()
		{
			function update()
			{
				var level = game.level,
					line = NaiveAlgorithm(level.points(0), level.points(1));
				game.slices = [];
				if (line)
					game.slice(line);
				field.updateLines();
			}

			function handle(circle)
			{
				circle
					.call(drag)
					.on('contextmenu', function (d)
					{
						d3.event.preventDefault();
						var level = game.level;
						function remove(arr, d)
						{
							var i = arr.indexOf(d);
							if (i >= 0)
								arr.splice(i, 1);
						}
						remove(level.entities, d);
						for (var i = level.groups.length -1; i >= 0; --i)
							remove(level.groups[i], d);

						field.updatePoints();
						update();
					})
				;
			}

			var bb = game.rect.shrink(5);
			var drag = d3.behavior.drag()
				.on('drag', function (d)
				{
					d.point.x = Math.min(Math.max(bb.x, d3.event.x), bb.x + bb.w);
					d.point.y = Math.min(Math.max(bb.y, d3.event.y), bb.y + bb.h);
					d3.select(this)
						.attr('cx', function (d) { return d.point.x })
						.attr('cy', function (d) { return d.point.y })
					;
					update();
				})
			;
			handle(field.svg.selectAll('.points circle'));

			field.svg.on('click', function ()
			{
				if (d3.event.defaultPrevented) return;
				var level = game.level;
				level.add(new Entity(new Point(d3.mouse(this)),
					+(level.groups[0].length > level.groups[1].length)));
				field.updatePoints();
				handle(field.svg.selectAll('.points circle'));
				update();
			});
		});
	</script>
</body>
</html>